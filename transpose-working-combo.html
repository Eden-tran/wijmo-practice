<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Wijmo Transposed Grid - InputCombo Dynamic Selection</title>

  <!-- Wijmo CDN CSS -->
  <link rel="stylesheet" href="https://cdn.mescius.com/wijmo/5.latest/styles/wijmo.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

  <style>
    body {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    .control-panel {
      margin-top: 20px;
    }
    
    .wj-transposedgrid {
      max-width: 100%;
      margin: 20px auto;
      border: 1px solid #ddd;
    }
    
    h4 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .description {
      color: #666;
      margin-bottom: 20px;
    }
    
    .info-text {
      background-color: #e3f2fd;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    /* Style ComboBox to fit perfectly in grid cells */
    .wj-grid .wj-combobox {
      width: 100% !important;
      height: 100% !important;
      border: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    .wj-grid .wj-combobox .wj-form-control {
      border: none !important;
      padding: 4px 8px !important;
      height: 100% !important;
      background: transparent !important;
      font-size: inherit !important;
      line-height: normal !important;
      margin: 0 !important;
    }
    
    .wj-grid .wj-combobox .wj-btn {
      border: none !important;
      background: transparent !important;
      height: 100% !important;
      width: 20px !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .wj-grid .wj-combobox .wj-btn:hover {
      background-color: #f0f0f0 !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <h4>Wijmo TransposedGrid - InputCombo Dynamic Selection</h4>
    <p class="description">
      Select Europe to see Germany and England, or select Asia to see Vietnam and Thailand.
    </p>
    
    <div class="info-text">
      <strong>Try this:</strong> Change the continent and then double-click on the country cell to see the filtered ComboBox options!
    </div>

    <div class="control-panel">
      <div id="trnGrid"></div>
    </div>

    <!-- Wijmo CDN JS -->
    <script src="https://cdn.mescius.com/wijmo/5.latest/controls/wijmo.min.js"></script>
    <script src="https://cdn.mescius.com/wijmo/5.latest/controls/wijmo.grid.min.js"></script>
    <script src="https://cdn.mescius.com/wijmo/5.latest/controls/wijmo.grid.transposed.min.js"></script>
    <script src="https://cdn.mescius.com/wijmo/5.latest/controls/wijmo.input.min.js"></script>

    <script>
      document.readyState === 'complete' ? init() : window.onload = init;

      function init() {
        // Get reference to wijmo.input namespace
        var input = wijmo.input;
        // Continent data
        const continents = [
          { id: 'europe', name: 'Europe' },
          { id: 'asia', name: 'Asia' }
        ];

        // Country data arrays based on continent
        const europeCountries = [
          { title: 'Germany', value: '1' },
          { title: 'England', value: '2' }
        ];

        const asiaCountries = [
          { title: 'Vietnam', value: '4' },
          { title: 'Thailand', value: '5' }
        ];
        
        // All countries for display
        const allCountries = [...europeCountries, ...asiaCountries];

        // Function to get countries based on continent
        function getCountriesByContinent(continentId) {
          switch(continentId) {
            case 'europe':
              return europeCountries;
            case 'asia':
              return asiaCountries;
            default:
              return [];
          }
        }

        // Function to get country name by value
        function getCountryName(value) {
          let country = allCountries.find(c => c.value === value);
          return country ? country.title : '';
        }

        // Sample data
        const data = [
          {
            continent: 'europe',
            country: '1'
          },
          {
            continent: 'asia',
            country: '4'
          },
          {
            continent: 'europe',
            country: '2'
          },
          {
            continent: 'asia',
            country: '5'
          }
        ];

        // Create the transposed grid
        let trnGrid = new wijmo.grid.transposed.TransposedGrid('#trnGrid', {
          alternatingRowStep: 0,
          showMarquee: true,
          showSelectedHeaders: wijmo.grid.HeadersVisibility.All,
          autoGenerateRows: false,
          rows: [
            { 
              binding: 'continent', 
              header: 'Continent', 
              width: 200,
              dataMap: new wijmo.grid.DataMap(continents, 'id', 'name')
            },
            { 
              binding: 'country', 
              header: 'Country', 
              width: 200,
              isReadOnly: false
            }
          ],
          itemsSource: data,
          selectionMode: wijmo.grid.SelectionMode.Cell
        });

        // Auto-size columns after grid is loaded
        trnGrid.loadedRows.addHandler(() => {
          trnGrid.columns.forEach(col => {
            col.width = '*';
          });
          
          trnGrid.rowHeaders.columns.forEach(col => {
            trnGrid.autoSizeColumn(col.index, true);
          });
        });

        // Format country cells to show names
        trnGrid.formatItem.addHandler((s, e) => {
          if (e.panel.cellType === wijmo.grid.CellType.Cell) {
            let row = e.panel.rows[e.row];
            
            // For country cells, show the country name
            if (row.binding === 'country' && !s.editRange) {
              let countryValue = e.panel.getCellData(e.row, e.col);
              e.cell.textContent = getCountryName(countryValue);
            }
          }
        });

        // Handle editing with Wijmo ComboBox
        trnGrid.beginningEdit.addHandler((s, e) => {
          let row = s.rows[e.row];
          
          if (row.binding === 'country') {
            // Cancel default editing
            e.cancel = true;
            
            // Get continent from row above
            let continentId = s.getCellData(e.row - 1, e.col);
            let filteredCountries = getCountriesByContinent(continentId);
            let currentValue = s.getCellData(e.row, e.col);
            
            // Create editor host
            let cell = s.cells.getCellElement(e.row, e.col);
            let hostDiv = document.createElement('div');
            hostDiv.style.width = '100%';
            hostDiv.style.height = '100%';
            hostDiv.style.margin = '0';
            hostDiv.style.padding = '0';
            hostDiv.style.border = 'none';
            hostDiv.style.display = 'block';
            
            // Clear cell and add host
            cell.innerHTML = '';
            cell.style.padding = '0';
            cell.appendChild(hostDiv);
            
            // Create ComboBox using your preferred syntax
            let editor = new input.ComboBox(hostDiv, {
              itemsSource: filteredCountries,
              displayMemberPath: 'title',
              selectedValuePath: 'value',
              selectedValue: currentValue,
              isEditable: true,
              isRequired: false,
              isDroppedDown: true
            });
            
            // Handle selection
            let commitEdit = () => {
              let newValue = editor.selectedValue;
              if (newValue !== undefined) {
                s.setCellData(e.row, e.col, newValue);
              }
              s.focus();
            };
            
            // Commit on selection change
            editor.selectedIndexChanged.addHandler(commitEdit);
            
            // Handle keyboard
            editor.hostElement.addEventListener('keydown', (evt) => {
              if (evt.key === 'Enter') {
                commitEdit();
                evt.preventDefault();
              } else if (evt.key === 'Escape') {
                s.focus();
                evt.preventDefault();
              }
            });
            
            // Handle lost focus
            editor.lostFocus.addHandler(() => {
              setTimeout(() => {
                if (!editor.containsFocus) {
                  commitEdit();
                }
              }, 100);
            });
            
            // Focus the editor
            setTimeout(() => {
              editor.focus();
            }, 50);
          }
        });

        // Handle continent change
        trnGrid.cellEditEnded.addHandler((s, e) => {
          let row = s.rows[e.row];
          
          if (row.binding === 'continent') {
            // Clear country selection in the same column if invalid
            let countryRowIndex = e.row + 1;
            if (countryRowIndex < s.rows.length) {
              let continentId = s.getCellData(e.row, e.col);
              let currentCountry = s.getCellData(countryRowIndex, e.col);
              
              // Check if current country is still valid for new continent
              let countries = getCountriesByContinent(continentId);
              let validCountry = countries.find(c => c.value === currentCountry);
              if (!validCountry) {
                // Clear if country is not valid for new continent
                s.setCellData(countryRowIndex, e.col, '');
              }
            }
          }
        });
      }
    </script>
  </body>
</html>