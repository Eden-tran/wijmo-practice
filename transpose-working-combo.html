<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Wijmo Transposed Grid - InputCombo Dynamic Selection</title>

  <!-- Wijmo CDN CSS -->
  <link rel="stylesheet" href="https://cdn.mescius.com/wijmo/5.latest/styles/wijmo.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

  <style>
    body {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    .control-panel {
      margin-top: 20px;
    }
    
    .wj-transposedgrid {
      max-width: 100%;
      margin: 20px auto;
      border: 1px solid #ddd;
    }
    
    h4 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .description {
      color: #666;
      margin-bottom: 20px;
    }
    
    .info-text {
      background-color: #e3f2fd;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    /* Style ComboBox to fit perfectly in grid cells */
    .wj-grid .wj-combobox {
      width: 100% !important;
      height: 100% !important;
      border: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    .wj-grid .wj-combobox .wj-form-control {
      border: none !important;
      padding: 4px 8px !important;
      height: 100% !important;
      background: transparent !important;
      font-size: inherit !important;
      line-height: normal !important;
      margin: 0 !important;
    }
    
    .wj-grid .wj-combobox .wj-btn {
      border: none !important;
      background: transparent !important;
      height: 100% !important;
      width: 20px !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .wj-grid .wj-combobox .wj-btn:hover {
      background-color: #f0f0f0 !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <h4>Wijmo TransposedGrid - InputCombo Dynamic Selection</h4>
    <p class="description">
      Select Europe to see Germany and England, or select Asia to see Vietnam and Thailand.
    </p>
    
    <div class="info-text">
      <strong>Try this:</strong> Change the continent and watch the country ComboBox update automatically! Country cells are always ComboBoxes.
    </div>

    <div class="control-panel">
      <div id="trnGrid"></div>
    </div>

    <!-- Wijmo CDN JS -->
    <script src="https://cdn.mescius.com/wijmo/5.latest/controls/wijmo.min.js"></script>
    <script src="https://cdn.mescius.com/wijmo/5.latest/controls/wijmo.grid.min.js"></script>
    <script src="https://cdn.mescius.com/wijmo/5.latest/controls/wijmo.grid.transposed.min.js"></script>
    <script src="https://cdn.mescius.com/wijmo/5.latest/controls/wijmo.input.min.js"></script>

    <script>
      document.readyState === 'complete' ? init() : window.onload = init;

      function init() {
        // Get reference to wijmo.input namespace
        var input = wijmo.input;
        // Continent data
        const continents = [
          { id: 'europe', name: 'Europe' },
          { id: 'asia', name: 'Asia' }
        ];

        // Country data arrays based on continent
        const europeCountries = [
          { title: 'Germany', value: '1' },
          { title: 'England', value: '2' }
        ];

        const asiaCountries = [
          { title: 'Vietnam', value: '4' },
          { title: 'Thailand', value: '5' }
        ];
        
        // All countries for display
        const allCountries = [...europeCountries, ...asiaCountries];

        // Function to get countries based on continent
        function getCountriesByContinent(continentId) {
          switch(continentId) {
            case 'europe':
              return europeCountries;
            case 'asia':
              return asiaCountries;
            default:
              return [];
          }
        }

        // Function to get country name by value
        function getCountryName(value) {
          let country = allCountries.find(c => c.value === value);
          return country ? country.title : '';
        }

        // Sample data
        const data = [
          {
            continent: 'europe',
            country: '1'
          },
          {
            continent: 'asia',
            country: '4'
          },
          {
            continent: 'europe',
            country: '2'
          },
          {
            continent: 'asia',
            country: '5'
          }
        ];

        // Create the transposed grid
        let trnGrid = new wijmo.grid.transposed.TransposedGrid('#trnGrid', {
          alternatingRowStep: 0,
          showMarquee: true,
          showSelectedHeaders: wijmo.grid.HeadersVisibility.All,
          autoGenerateRows: false,
          rows: [
            { 
              binding: 'continent', 
              header: 'Continent', 
              width: 200,
              dataMap: new wijmo.grid.DataMap(continents, 'id', 'name')
            },
            { 
              binding: 'country', 
              header: 'Country', 
              width: 200,
              isReadOnly: false
            }
          ],
          itemsSource: data,
          selectionMode: wijmo.grid.SelectionMode.Cell
        });

        // Auto-size columns after grid is loaded
        trnGrid.loadedRows.addHandler(() => {
          trnGrid.columns.forEach(col => {
            col.width = '*';
          });
          
          trnGrid.rowHeaders.columns.forEach(col => {
            trnGrid.autoSizeColumn(col.index, true);
          });
        });

        // Store ComboBox instances for each country cell
        const countryComboBoxes = {};
        let comboBoxesInitialized = false;

        // Initialize ComboBoxes after grid is loaded
        trnGrid.loadedRows.addHandler(() => {
          if (!comboBoxesInitialized) {
            setTimeout(() => {
              initializeCountryComboBoxes();
              comboBoxesInitialized = true;
            }, 200);
          }
        });

        function initializeCountryComboBoxes() {
          let countryRowIndex = trnGrid.rows.findIndex(r => r.binding === 'country');
          if (countryRowIndex === -1) return;
          
          for (let col = 0; col < trnGrid.columns.length; col++) {
            createCountryComboBox(countryRowIndex, col);
          }
        }

        function createCountryComboBox(row, col) {
          let continentId = trnGrid.getCellData(row - 1, col);
          let countryValue = trnGrid.getCellData(row, col);
          let cellKey = `${row}_${col}`;
          
          // Get cell element
          let cell = trnGrid.cells.getCellElement(row, col);
          if (!cell) return;
          
          // Check if control already exists
          if (wijmo.Control.getControl(cell)) {
            console.log('Control already exists for cell', row, col);
            return;
          }
          
          // Clear cell and remove padding
          cell.innerHTML = '';
          cell.style.padding = '0';
          cell.style.margin = '0';
          
          // Create a host div for the ComboBox
          let hostDiv = document.createElement('div');
          hostDiv.style.width = '100%';
          hostDiv.style.height = '100%';
          hostDiv.style.margin = '0';
          hostDiv.style.padding = '0';
          cell.appendChild(hostDiv);
          
          // Create ComboBox in the host div
          try {
            let combo = new input.ComboBox(hostDiv, {
              itemsSource: getCountriesByContinent(continentId),
              displayMemberPath: 'title',
              selectedValuePath: 'value',
              selectedValue: countryValue,
              isEditable: false,
              isRequired: false
            });
            
            // Store reference
            countryComboBoxes[cellKey] = combo;
            
            // Handle selection changes
            combo.selectedIndexChanged.addHandler(() => {
              // Update data without triggering full refresh
              let data = trnGrid.collectionView.sourceCollection[col];
              if (data) {
                data.country = combo.selectedValue || '';
                // Notify grid of change without full refresh
                trnGrid.collectionView.refresh();
              }
            });
            
          } catch (error) {
            console.error('Error creating ComboBox for cell', row, col, ':', error);
            // Fallback to text
            cell.textContent = getCountryName(countryValue);
          }
        }

        // Prevent default editing for country cells since they're always ComboBoxes
        trnGrid.beginningEdit.addHandler((s, e) => {
          let row = s.rows[e.row];
          if (row.binding === 'country') {
            e.cancel = true; // Cancel editing since ComboBox handles it
          }
        });

        // Use formatItem to ensure ComboBoxes stay visible
        trnGrid.formatItem.addHandler((s, e) => {
          if (e.panel.cellType === wijmo.grid.CellType.Cell) {
            let row = e.panel.rows[e.row];
            
            // For country cells, ensure ComboBox is visible
            if (row.binding === 'country') {
              let cellKey = `${e.row}_${e.col}`;
              let combo = countryComboBoxes[cellKey];
              
              // If ComboBox exists but not in DOM, re-add it
              if (combo && !e.cell.contains(combo.hostElement)) {
                e.cell.innerHTML = '';
                e.cell.style.padding = '0';
                e.cell.appendChild(combo.hostElement);
              }
              // If no ComboBox exists, create one
              else if (!combo) {
                createCountryComboBox(e.row, e.col);
              }
            }
          }
        });

        // Handle continent change
        trnGrid.cellEditEnded.addHandler((s, e) => {
          let row = s.rows[e.row];
          
          if (row.binding === 'continent') {
            // Update country ComboBox in the same column
            let countryRowIndex = e.row + 1;
            if (countryRowIndex < s.rows.length) {
              let continentId = s.getCellData(e.row, e.col);
              let currentCountry = s.getCellData(countryRowIndex, e.col);
              let cellKey = `${countryRowIndex}_${e.col}`;
              
              // Get the ComboBox for this cell
              let combo = countryComboBoxes[cellKey];
              if (combo) {
                // Update ComboBox with new country list
                let countries = getCountriesByContinent(continentId);
                combo.itemsSource = countries;
                
                // Check if current selection is still valid
                let validCountry = countries.find(c => c.value === currentCountry);
                if (!validCountry) {
                  // Clear selection if not valid
                  combo.selectedValue = null;
                  s.setCellData(countryRowIndex, e.col, '');
                } else {
                  combo.selectedValue = currentCountry;
                }
              }
              
              // Refresh the grid to update display
              s.invalidate();
            }
          }
        });
      }
    </script>
  </body>
</html>